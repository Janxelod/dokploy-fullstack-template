name: Deploy Docker Image on Pull Request

on:
  workflow_call:

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Authenticate user
        id: user_auth
        uses: fjogeleit/http-request-action@v1
        with:
          url: '${{secrets.DEPLOY_AUTH_URL}}/login'
          method: 'POST'
          data: '{"userName": "${{secrets.DEPLOY_USERNAME}}", "password": "${{secrets.DEPLOY_PASSWORD}}"}'
      - name: Deploying API
        id: deploy_api
        uses: fjogeleit/http-request-action@v1
        with:
          url: '${{secrets.DEPLOY_API_URL}}'
          method: 'POST'
          bearerToken: ${{ fromJson(steps.user_auth.outputs.response).accessToken }}
          data: '{"sourceProjectName": "${{secrets.SOURCE_PROJECT_NAME}}", "serviceName": "api", "branchName": "${{ github.head_ref || github.ref_name }}","sourceAppId": "${{ secrets.SOURCE_API_APP_ID }}", "projectId": "${{ secrets.PROJECT_ID }}", "options": {"replaceEnvVar": {"key": "FRONTEND_URL", "newValue": "https://${{ secrets.SOURCE_PROJECT_NAME }}-frontend-${{ github.head_ref || github.ref_name }}.${{secrets.PREVIEW_DOMAIN_SUFFIX}}"}}}'
      - name: Deploying Frontend
        id: deploy_frontend
        uses: fjogeleit/http-request-action@v1
        with:
          url: '${{secrets.DEPLOY_API_URL}}'
          method: 'POST'
          bearerToken: ${{ fromJson(steps.user_auth.outputs.response).accessToken }}
          data: '{"sourceProjectName": "${{secrets.SOURCE_PROJECT_NAME}}", "serviceName": "frontend", "branchName": "${{ github.head_ref || github.ref_name }}","sourceAppId": "${{ secrets.SOURCE_FRONTEND_APP_ID }}", "projectId": "${{ secrets.PROJECT_ID }}", "options": {"replaceEnvVar": {"key": "NEXT_PUBLIC_API_HOST", "newValue": "https://${{ secrets.SOURCE_PROJECT_NAME }}-api-${{ github.head_ref || github.ref_name }}.${{secrets.PREVIEW_DOMAIN_SUFFIX}}"}}}'
      - name: Save API output in ENV
        run: |
          echo 'PREVIEW_API_URL=https://${{ fromJson(steps.deploy_api.outputs.response).previewDomain }}' >> $GITHUB_ENV
      - name: Save Frontend output in ENV
        run: |
          echo 'PREVIEW_FRONTEND_URL=https://${{ fromJson(steps.deploy_frontend.outputs.response).previewDomain }}' >> $GITHUB_ENV
      - name: Find Comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: This comment was written by a bot!
      - name: Create comment
        if: steps.find_comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Preview URL: [API](${{ env.PREVIEW_API_URL }}) | [Frontend](${{ env.PREVIEW_FRONTEND_URL }})
            This comment was written by a bot!
          reactions: |
            rocket
            rocket
      - name: Update comment
        if: steps.find_comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            **Edit:** 
            Preview URL: [API](${{ env.PREVIEW_API_URL }}) | [Frontend](${{ env.PREVIEW_FRONTEND_URL }})
            This comment was written by a bot!
          reactions: hooray
